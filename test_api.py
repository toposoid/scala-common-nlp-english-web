'''
  Copyright 2021 Linked Ideal LLC.[https://linked-ideal.com/]
 
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
 
      http://www.apache.org/licenses/LICENSE-2.0
 
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
 '''
from fastapi.testclient import TestClient
from api import app
from model import NormalizedWord, SynonymList, FeatureVector
import pytest

#This is a unit test module

class TestVoldAPI(object):

    client = TestClient(app)

    def test_EmptyWord(self):    
        response = self.client.post("/getSynonyms",
                            headers={"Content-Type": "application/json"},
                            json={"word": ""})    
        assert response.status_code == 200
        synonymList = SynonymList.parse_obj(response.json())
        assert synonymList.synonyms == []

    def test_SimpleVerb(self):    
        response = self.client.post("/getSynonyms",
                            headers={"Content-Type": "application/json"},
                            json={"word": "execute"})    
        assert response.status_code == 200
        synonymList = SynonymList.parse_obj(response.json())
        assert synonymList.synonyms.sort() == ['accomplish', 'perform'].sort()

    def test_SimpleNoun(self):    
        response = self.client.post("/getSynonyms",
                            headers={"Content-Type": "application/json"},
                            json={"word": "agreement"})    
        assert response.status_code == 200
        synonymList = SynonymList.parse_obj(response.json())
        assert synonymList.synonyms.sort() == ['accord', 'arrangement'].sort()

    def test_VocabularyNotFoundInWordNet(self):    
        response = self.client.post("/getSynonyms",
                            headers={"Content-Type": "application/json"},
                            json={"word": "research"})    
        assert response.status_code == 200
        synonymList = SynonymList.parse_obj(response.json())
        assert synonymList.synonyms.sort() == ['RESEARCH', 'Studies', 'STUDIES', 'Research', 'studies'].sort()

    def test_VocabularyNotFoundInWord2Vec(self):    
        response = self.client.post("/getSynonyms",
                            headers={"Content-Type": "application/json"},
                            json={"word": "aslkfjg"})    
        assert response.status_code == 200
        synonymList = SynonymList.parse_obj(response.json())
        assert synonymList.synonyms == []

    def test_GetFeatureVector(self):
        import math
        response = self.client.post("/getFeatureVector",
                            headers={"Content-Type": "application/json"},
                            json={"sentence": "This is a test."})    
        assert response.status_code == 200
        featureVector = FeatureVector.parse_obj(response.json())        
        correctVector = [0.1524999439716339, 0.48042741417884827, -0.30528321862220764, -0.04725565388798714, 0.03611695393919945, -0.12813147902488708, 0.5153798460960388, 0.03524904325604439, -0.14065973460674286, -0.12373621016740799, 0.12760306894779205, -0.6661005020141602, -0.0023319567553699017, 0.16075466573238373, -0.39777469635009766, -0.23029246926307678, -0.05268416553735733, -0.3773220479488373, 0.15857362747192383, 0.2933051586151123, 0.5503929257392883, -0.014684787020087242, -0.0528985895216465, -0.02852769009768963, -0.1834334135055542, -0.05381852015852928, 0.32409247756004333, 0.06965936720371246, 0.1820612996816635, -0.2165127545595169, -0.19431297481060028, -0.061628006398677826, 0.0015103766927495599, -0.3108256459236145, 0.18439577519893646, 0.0035882124211639166, -0.03922645375132561, -0.10801354795694351, 0.1313697248697281, 0.003953459672629833, 0.06638817489147186, -0.535983681678772, 0.11187206953763962, 0.3129540979862213, 0.3224700391292572, 0.45832306146621704, -0.0061958348378539085, -0.10087092220783234, -0.044640086591243744, 0.061996255069971085, -0.13195618987083435, -0.42539772391319275, -0.14529874920845032, -0.41175562143325806, 0.1378294676542282, -0.11425884813070297, 0.1561739146709442, 0.029742499813437462, -0.24602010846138, 0.17034432291984558, 0.1388351321220398, -0.1380174458026886, -0.35392338037490845, 0.34040671586990356, 0.18003809452056885, -0.2629149258136749, 0.083292655646801, -0.19835567474365234, 0.05387691780924797, 0.3146360516548157, -0.4350075423717499, -0.030070940032601357, 0.02633485198020935, 0.10091245174407959, 0.022895915433764458, 0.4398996829986572, -0.13980796933174133, -0.07333444803953171, 0.21191655099391937, -0.10002732276916504, 0.15865668654441833, 0.11868082731962204, -0.0253800880163908, -0.017017556354403496, 0.3438427746295929, 0.2770683169364929, -0.15068648755550385, 0.34168264269828796, -0.13162031769752502, 0.03693100064992905, 0.3649758994579315, -0.1669314056634903, 0.20066659152507782, 0.09731701761484146, 0.4390931725502014, -0.01966140978038311, 0.04766923561692238, -0.20715869963169098, 0.24730589985847473, 0.8506559729576111, -0.0898219496011734, 0.06001364439725876, -0.38597920536994934, -0.0014240039745345712, -0.013544110581278801, 0.15390178561210632, -0.1681586503982544, -0.4175908863544464, 0.1384660303592682, -0.13782860338687897, -0.0027292424347251654, -0.007086624391376972, 0.09866245090961456, 0.36387011408805847, 0.11444922536611557, -0.1702962964773178, 0.06400931626558304, 0.07292325049638748, -0.14065603911876678, 0.7523465156555176, 0.21216726303100586, -0.46923309564590454, 0.1521013081073761, -0.32681846618652344, 0.5136815309524536, -0.7227687835693359, 0.11863519251346588, 0.20656593143939972, 0.1449810117483139, -0.15876992046833038, 0.4863394796848297, 0.2634255886077881, -0.42269906401634216, 0.30973392724990845, -0.30366775393486023, -0.0038864430971443653, 0.2386239916086197, 0.3598708510398865, 0.22732119262218475, 0.23269125819206238, -0.3230474591255188, 0.28389811515808105, 0.1762704700231552, 0.38446110486984253, -0.26893725991249084, -0.04619292542338371, -0.6391482949256897, 0.17119856178760529, 0.16002073884010315, -0.2772633731365204, 0.37068477272987366, -0.17779794335365295, 0.008257351815700531, 0.15721860527992249, -0.38516393303871155, -0.2868468761444092, 0.11244463175535202, 0.23406751453876495, 0.08188118040561676, -0.28408724069595337, -0.37200087308883667, 0.2586425840854645, -0.23824191093444824, 0.25133877992630005, 0.4313792586326599, -0.2514585852622986, -0.04212924838066101, -0.10390578210353851, -0.06120714917778969, 0.17080962657928467, 0.7559390068054199, -0.031469639390707016, -0.04958445578813553, -0.2825797200202942, -0.1550811231136322, 0.1258896291255951, -0.06613891571760178, 0.5098056793212891, -0.3341354429721832, 0.08255060017108917, 0.21023526787757874, -0.20754317939281464, -0.09130265563726425, -0.07744205743074417, -0.08250989764928818, 0.15492992103099823, -0.28943902254104614, -0.1108095720410347, 0.1519528478384018, 0.3339686691761017, -0.03468519076704979, 0.05195542052388191, -0.20151355862617493, 0.4826897978782654, -0.3462556004524231, -0.1561870574951172, 0.3568728566169739, -0.19070753455162048, -0.12831443548202515, -0.30646246671676636, -0.1251329779624939, -0.1996469497680664, 0.09525050967931747, -0.29454249143600464, 0.42439037561416626, 0.09984243661165237, 0.2594173848628998, -0.7176781892776489, 0.33575791120529175, 0.02038760483264923, -0.4765109121799469, -0.16061754524707794, -0.19782589375972748, -0.009922723285853863, 0.05765369161963463, -0.1948045939207077, -0.12961985170841217, -0.13754837214946747, -0.018500477075576782, 0.0816883072257042, -0.2907011806964874, -0.37616944313049316, 0.24800164997577667, -0.7273216843605042, -0.3319531977176666, -0.12322743982076645, -0.06157715246081352, 0.25672096014022827, 0.2981226444244385, -0.31047675013542175, 0.8030520081520081, 0.037659745663404465, 0.04540712386369705, 0.21636350452899933, 0.2668299973011017, -0.3624700605869293, -0.5498879551887512, 0.3554929792881012, -0.12291229516267776, -0.12119346112012863, -0.21012158691883087, -0.07608292996883392, 0.16730229556560516, -0.024870898574590683, -0.003563493024557829, 0.32052093744277954, 0.1782504767179489, 0.36294981837272644, -0.17455221712589264, 0.20416834950447083, -0.41046181321144104, -0.6832084059715271, 0.03555832430720329, -0.0008682034094817936, -0.2552860677242279, -0.1576600819826126, 0.1823430061340332, 0.8335527181625366, 0.06779035180807114, -0.10947443544864655, 0.5992329716682434, -0.23379631340503693, 0.020120438188314438, -0.05289449170231819, 0.032632216811180115, 0.11210779845714569, 0.021898195147514343, 0.1933484971523285, -0.07456310838460922, 0.27041175961494446, 0.12523646652698517, -0.19066452980041504, -0.07239633053541183, 0.20251180231571198, 0.08509193360805511, -0.13695427775382996, 0.054390303790569305, 0.13126970827579498, -0.0805669054389, 0.035197798162698746, -0.23639307916164398, -0.4047561585903168, -0.08622421324253082, 0.05894936993718147, 0.3098032474517822, -0.1731201559305191, 0.2108025848865509, -0.10615449398756027, 0.018416618928313255, 0.08799242228269577, -0.20725536346435547, 0.4391777217388153, 0.17693252861499786, 0.05184309929609299, -0.31132301688194275, -0.014501879923045635, 0.0680728405714035, -0.3522845208644867, 0.09829401224851608, -0.05196041613817215, -0.36319229006767273, 0.2673376500606537, -0.5000462532043457, -0.0398467518389225, -0.027201935648918152, -0.1393059939146042, 0.16166336834430695, 0.3622519075870514, 0.24494525790214539, -0.08381229639053345, -0.0056301625445485115, -0.02472037449479103, -0.03519944101572037, 0.3605585992336273, 0.1940307319164276, 0.05921102315187454, -0.33685407042503357, -0.23791185021400452, 0.18378467857837677, -0.5032899975776672, -0.12127319723367691, -0.2481675148010254, -0.3441307544708252, -0.03282357379794121, -0.0474926233291626, 0.21721415221691132, -0.2887384295463562, -0.5030452609062195, -0.059100423008203506, -0.2527638375759125, -0.07644631713628769, 0.491739422082901, -0.3769579231739044, -0.09846267849206924, -0.06350968778133392, 0.18747326731681824, -0.27629920840263367, 0.2763958275318146, -0.16051125526428223, -0.03879948705434799, -0.012390755116939545, -0.2700482904911041, -0.039780110120773315, -0.015664849430322647, -0.09691382944583893, 0.1349160373210907, -0.12845537066459656, -0.15998871624469757, -0.1300790160894394, -0.2989368140697479, 0.11192894726991653, 0.31240224838256836, -0.12129949033260345, -0.0704507976770401, 0.20213398337364197, 0.14802038669586182, -0.12648986279964447, 0.3033497929573059, 0.21646323800086975, 0.16344745457172394, -0.2596360743045807, -0.28702500462532043, -0.10634192079305649, 0.2635798156261444, 0.17616227269172668, -0.04409775510430336, -0.45018795132637024, -0.18944542109966278, -0.1452680081129074, -0.09850520640611649, -0.09861451387405396, -0.028936102986335754, -0.08232961595058441, -0.19142340123653412, 0.1754039078950882, 0.20781071484088898, 0.1824997216463089, -0.13995833694934845, -0.3895506262779236, 0.22838325798511505, 0.3373994827270508, 0.4167574346065521, 0.2947978675365448, 0.16614612936973572]
        x = False in list(map(lambda x: math.isclose(x[0], x[1], abs_tol=0.00001), zip(featureVector.vector, correctVector)))
        assert not x
